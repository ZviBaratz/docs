



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://brain-life.github.io/docs/apps/container/">
      
      
        <meta name="author" content="Soichi Hayashi">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../..//img/favicon.ico">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.0">
    
    
      
        <title>Containerizing App - Brainlife Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.78aab2dc.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="light-blue" data-md-color-accent="">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#containerizing-app" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://brain-life.github.io/docs/" title="Brainlife Documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Brainlife Documentation
              </span>
              <span class="md-header-nav__topic">
                Containerizing App
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/brain-life/docs/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      brain-life/docs
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Brainlife Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/brain-life/docs/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      brain-life/docs
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Brainlife UI
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Brainlife UI
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../user/tutorial/" title="Tutorial" class="md-nav__link">
      Tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user/project/" title="Projects" class="md-nav__link">
      Projects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user/datatypes/" title="Datatypes" class="md-nav__link">
      Datatypes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user/process/" title="Processes" class="md-nav__link">
      Processes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user/pipeline/" title="Pipelines" class="md-nav__link">
      Pipelines
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user/publication/" title="Publication" class="md-nav__link">
      Publication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      App Developers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        App Developers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../helloworld/" title="HelloWorld" class="md-nav__link">
      HelloWorld
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../register/" title="Registering App" class="md-nav__link">
      Registering App
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Containerizing App
      </label>
    
    <a href="./" title="Containerizing App" class="md-nav__link md-nav__link--active">
      Containerizing App
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docker-engine" title="Docker Engine" class="md-nav__link">
    Docker Engine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-matlab-scripts" title="Compiling Matlab Scripts" class="md-nav__link">
    Compiling Matlab Scripts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compilesh" title="compile.sh" class="md-nav__link">
    compile.sh
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-custom-matlab-data-structure" title="Loading custom Matlab data structure" class="md-nav__link">
    Loading custom Matlab data structure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-docker-container" title="Creating Docker Container" class="md-nav__link">
    Creating Docker Container
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ldconfig" title="ldconfig" class="md-nav__link">
    ldconfig
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iu-hpc-paths" title="IU HPC paths" class="md-nav__link">
    IU HPC paths
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-bash" title="Use Bash" class="md-nav__link">
    Use Bash
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-dockerfile-for-environment-containers" title="Example Dockerfile for environment containers" class="md-nav__link">
    Example Dockerfile for environment containers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples-apps-using-environment-containers" title="Examples Apps using environment containers" class="md-nav__link">
    Examples Apps using environment containers
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../versioning/" title="Versioning Tips" class="md-nav__link">
      Versioning Tips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../customhooks/" title="Custom Hooks" class="md-nav__link">
      Custom Hooks
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Resource Provider
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Resource Provider
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../resources/register/" title="Registering Resource" class="md-nav__link">
      Registering Resource
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Technical
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Technical
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../technical/arthitecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../technical/api/" title="APIs" class="md-nav__link">
      APIs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contact/" title="Contact" class="md-nav__link">
      Contact
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../terms/" title="Terms of Use" class="md-nav__link">
      Terms of Use
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../releases/" title="Releases" class="md-nav__link">
      Releases
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docker-engine" title="Docker Engine" class="md-nav__link">
    Docker Engine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-matlab-scripts" title="Compiling Matlab Scripts" class="md-nav__link">
    Compiling Matlab Scripts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compilesh" title="compile.sh" class="md-nav__link">
    compile.sh
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-custom-matlab-data-structure" title="Loading custom Matlab data structure" class="md-nav__link">
    Loading custom Matlab data structure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-docker-container" title="Creating Docker Container" class="md-nav__link">
    Creating Docker Container
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ldconfig" title="ldconfig" class="md-nav__link">
    ldconfig
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iu-hpc-paths" title="IU HPC paths" class="md-nav__link">
    IU HPC paths
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-bash" title="Use Bash" class="md-nav__link">
    Use Bash
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-dockerfile-for-environment-containers" title="Example Dockerfile for environment containers" class="md-nav__link">
    Example Dockerfile for environment containers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples-apps-using-environment-containers" title="Examples Apps using environment containers" class="md-nav__link">
    Examples Apps using environment containers
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/brain-life/docs/edit/master/docs/apps/container.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="containerizing-app">Containerizing App<a class="headerlink" href="#containerizing-app" title="Permanent link">&para;</a></h1>
<p>Docker is a software containerization tool that allow you to package your App and its dependencies into a portable <em>container</em> that can you can run on any machine that supports Docker engine, or singularity.</p>
<p>Although you can create a fully functional standalone Docker container for your app, for Brainlife, we recommend to containerize only the App's <em>environment and the dependencies</em>, and not include the main part of your App (your python or Matlab scripts that drives your algorithm) on your container.</p>
<p>You can use singularity to run the most ideosyncratic parts of your App which can be stored and maintained inside your github repo and injected into an environment container at runtime. Like..</p>
<div class="codehilite"><pre><span></span>singularity <span class="nb">exec</span> -e docker://brainlife/dipy:0.13 ./app.py
</pre></div>


<p>In above example, I am using <code>brainlife/dipy:0.13</code> as an environment container, and running app.py which is stored locally (comes with the github repo for my App) and injected into my environment at runtime. </p>
<p>You can even share the same Docker container across multiple Apps that you and your lab members maintain, but you should make sure to specify the container version ("0.13" in above example) so that your App won't be affected when the container gets updated. </p>
<h2 id="docker-engine">Docker Engine<a class="headerlink" href="#docker-engine" title="Permanent link">&para;</a></h2>
<p>To build a docker container, you need to <a href="https://docs.docker.com/machine/install-machine/">install Docker engine on your laptop</a> or find a server that has docker engine installed that you can use. (Contact <a href="../hayashis@iu.edu">Soichi</a> if you need a help.)</p>
<p>We assume you already have your Brainlife app hosted on Github, and you are making changes inside a cloned git repo on a machine with Docker engine.</p>
<h2 id="compiling-matlab-scripts">Compiling Matlab Scripts<a class="headerlink" href="#compiling-matlab-scripts" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Skip this section if you are not using Matlab</p>
</blockquote>
<p>Matlab code requires a matlab license to run. If you are App contains any Matlab code, it needs to be compiled to a binary format using <a href="https://www.mathworks.com/help/compiler/mcc.html"><code>mcc</code> command</a> which allows you to execute your code without Matlab license. You will still need to run it against a special Matlab compiled runtime called <em>MCR</em> which can be distributed freely and does not require any license.</p>
<p>You can create a script that compiles your matlab code.</p>
<h4 id="compilesh">compile.sh<a class="headerlink" href="#compilesh" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>
module load matlab/2017a

mkdir -p compiled

cat &gt; build.m <span class="s">&lt;&lt;END</span>
<span class="s">addpath(genpath(&#39;/N/u/brlife/git/vistasoft&#39;))</span>
<span class="s">addpath(genpath(&#39;/N/u/brlife/git/jsonlab&#39;))</span>
<span class="s">addpath(genpath(&#39;/N/soft/mason/SPM/spm8&#39;))</span>
<span class="s">mcc -m -R -nodisplay -d compiled myapp</span>
<span class="s">%# function sptensor</span>
<span class="s">exit</span>
<span class="s">END</span>
matlab -nodisplay -nosplash -r build
</pre></div>


<p>This script generates a Matlab script called <code>build.m</code> and immediately executes it. <code>build.m</code> will load Matlab paths and run Matlab command called <code>mcc</code> which actually compiles of your Matlab code into an executable binary that can run without Matlab license. The generated binary still requires a few Matlab proprietary libraries called MCR which can be download from Matlab website. </p>
<div class="admonition note">
<p class="admonition-title">Note<p>Brainlife team has built a Docker MCR container <a href="https://hub.docker.com/r/brainlife/mcr/tags/">brainlife/mcr</a> which can be used to execute your compiled Matlab code with singularity.</p>
</p>
</div>
<p>For the sample build script above, you will need to adjust addpath() to include all of your Matlab dependencies that your Matlab script requires. <code>myapp</code> is the name of the matlab entry function that you use to execute your application. mcc command will create a binary with the same name <code>myapp</code> inside the ./compiled directory.</p>
<p>A few other mcc options to note.</p>
<ul>
<li><code>-m ...</code> tells the name of the main entry function (in this case it's <code>main</code>) of your application (it reads your config.json and runs the whole application)</li>
<li><code>-R -nodisplay</code> sets the command line options you'd normally pass when you run MatLab on the command line.</li>
<li>-d ...` tells where to output the generated binary. You should avoid writing it out to the application root directory; just to keep things organized.</li>
<li>
<p>If your app or your Matlab libraries access any non-Matlab script (any mexfiles, datafiles, models, templates, etc..) you will also need to include them by specifying its parent directory with <code>-a</code>. mcc will then include specified files/directories as part of your compiled binary and make it available to the compiled code as if it is loading from the host file system (similar to how Docker containerizes things). For example...
        <code>mcc -m -R -nodisplay -a /N/u/hayashis/BigRed2/git/encode/mexfiles -d compiled myapp</code></p>
</li>
<li>
<p>If you are using OpenMP, you will need to include libgomp1 library installed in your MCR container.</p>
</li>
<li>mcc compiled application can't run certain Matlab statements; like addpath. You will need to wrap some code with <code>if ~isdeployed</code> type statement to prevent it from getting executed.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note<p>If you are loading any custom paths via startup.m, those paths may influence how your binary is compiled. At the moment, I don't know a good way to prevent it from loaded when you run build.m. The only workaround is to temporarly rename your startup.m to something else while you are compiling your code.s</p>
</p>
</div>
<h3 id="loading-custom-matlab-data-structure">Loading custom Matlab data structure<a class="headerlink" href="#loading-custom-matlab-data-structure" title="Permanent link">&para;</a></h3>
<p>If your Matlab code is loading any data structure that contains custom Matlab data structures (like sparse tensor array in encode's fe structure), addpath() is not enough to include those data structures. You will need to explicitly tell Matlab compiler that you are using those data structures, like..</p>
<p><code>%# function sptensor</code></p>
<p>This odd looking <em>comment</em> lets the Matlab compiler know that it should include the sptensor class to the compiled binary.</p>
<!--
## Create Dockerfile (MatLab)

Before you start working on Dockerfile, make sure you are already familiar with the basic concepts of Docker and [how to build a docker container](https://docs.docker.com/engine/reference/builder/). 

All Docker containers have a base-container. This base is used to derive all other containers. If your application uses Matlab, then I recommend using[the Brain-Life Docker Container](https://hub.docker.com/r/brainlife/mcr/). Alternatively, you could also use a more general OS container such as a Ubuntu, CentOS. The [neurodebian container](https://store.docker.com/images/63dbd2e1-f29e-498b-8b16-1477770ae733?tab=description) is a good alternative.

On this example, I am going to use [the LiFE Docker Container](https://github.com/brain-life/app-life/blob/master/Dockerfile) as a template (this was compiled using MCR:2016a on Ubuntu Linux compatible with NeuroDebian), but we are going to [app-dtiinit](https://github.com/brain-life/app-dtiinit) as an example to build a Docker container. To start:

1. cd into your local app-dtiinit folder (this folder should have the main file). 
2. copy the Dockerfile from [online](https://github.com/brain-life/app-life/blob/master/Dockerfile) into the current directory.
3. Open the `Dockerfile` and add the following lines, which will add a series of Docker commands: 
   1. Set the Docker base image and maintainer.
   ```
   FROM brainlife/mcr:R2016a
   MAINTAINER Your Name <youremail@iu.edu>
   ```
   2. Add dependencies. 
   This app requires the external, package FSL  to add this dependency we will the following lines to the Dockerfile.

   ```
   RUN sudo apt-get install fsl-complete
   ```
   3. Add the app-dtiinit to the Docker. 
   We want to put the entire content of you git repository (in our example because we have some MatLab code, the repository has been previously made into a standalone executable and compiled and the compiled version is under app-dtiinit/msa) on to this container somewhere. I am going to put it under /app.
   ```
   ADD . /app
   ```

   4. Lastly, need to specify the output directory to use
   ```
   RUN mkdir /output
   WORKDIR /output
   ```

   5. Then set the entry point of your application
   ```
   ENTRYPOINT ["/app/docker.sh"]
   ```

3b. Prepare for your container to be run under singularity. Singularity allows users to run your container where they don't have root access (or docker engine access). One issue with running Docker container under singularity is that, often dynamically linked libraries creates symlinks under /usr/lib64 directory when they are first executed. (TODO - explain why this fails under singularity). To setup all necessary symlinks before singularity executes the container, run ldconfig at the end of your Dockerfile

   ```
   RUN ldconfig
   ```

   For more information about singularity, please see http://singularity.lbl.gov/docs-docker#best-practices

4. Now, create a sample config.json on your current directory to be used..

`config.json`

wzxhzdk:2


5. Build the container (make sure to name it something like `-t brainlife/someapp`), 


wzxhzdk:3


6. Then run it to test it


wzxhzdk:4


7 (optional). You can also save the above two commands into separate .sh files for ease of access. 


wzxhzdk:5


Do something similar for building the container into its own build.sh file.

## Create DockerFile (Python)

There are a few differences between the Matlab and Python versions of DockerFile. Namely the version and dependencies. While the Matlab one will show how to create one from an existing DockerFile, this part will show how to create a DockerFile from scratch. Please remember to install Docker before continuing.

1. In the folder of your Brain-Life application. Create a file called DockerFile.


wzxhzdk:6


2. In the DockerFile, set the OS and version of Python you would like to use.


wzxhzdk:7


3. Now install the dependencies your application requires.

To install pip and git, which you would most likely want to do, add the following to your DockerFile.


wzxhzdk:8


To pip install your dependencies add the following command:


wzxhzdk:9


To git clone a repository and install from there add the following


wzxhzdk:10


4. Now we need to make a folder for adding our main python files. The DockerFile will run your applications from here.


wzxhzdk:11


Copy all necessary python files into the app folder.

5. We will now create a folder for the output of your application.


wzxhzdk:12


If you want to test your application locally, make sure you have your **local** config.json file in the output folder.

6. If you did any git clones and install from the setup.py in there make sure you also set the PYTHONPATH like so

If you installed everything from pip, you may skip this step.

wzxhzdk:13


7. Finally, we add the last line to finish up our DockerFile.


wzxhzdk:14


Congratulations! You wrote the DockerFile! You can see a full example here: "add example here Aman"

## Building and running your container

1. Build the container (make sure to name it something like `-t brainlife/someapp`), 


wzxhzdk:15


2. Then run it to test it


wzxhzdk:16


3 (optional). You can also save the above two commands into separate .sh files for ease of access. 

run_docker.sh

wzxhzdk:17


Do something similar for building the container into its own build.sh file.


wzxhzdk:18


You only need to run the build once, unless you change something in your DockerFile. Otherwise you can directly run with the command or with run_docker.sh.

You will also probably need to give your run_docker.sh and build.sh permissions.


wzxhzdk:19


## README

Once you know that your container works, you should push your container to docker hub and update the README of your git repo to include instructions on how to run your container.

-->

<h2 id="creating-docker-container">Creating Docker Container<a class="headerlink" href="#creating-docker-container" title="Permanent link">&para;</a></h2>
<p>There are quite a few materials detailing how to write Dockerfile / containers online. If you are looking for a place to start, we recommend <a href="https://docs.docker.com/get-started/">Docker's Getting Started Guide</a>.</p>
<p>As most Brainlife Apps execute Docker containers through singularity, there are a few Brainlife specific items that you might need to be aware so that your App will run properly on Brainlife.</p>
<h3 id="ldconfig">ldconfig<a class="headerlink" href="#ldconfig" title="Permanent link">&para;</a></h3>
<p>As singularity runs containers as a normal user, we must perform some OS level initialization steps outside the singularity.</p>
<p>When Docker installs OS packages, it won't initialize dynamicly linked library links until they are first invoked. As singularity runs as normal user with set uid disabled, it won't be able to setup these paths once container is executed through singularity. To fix this, we can run <code>ldconfig</code> command. This command creates the necessary links and cache to the most recent shared libraries installed in the lib directories. In your Dockerfile, please be sure to run ldconfig as the last command. Like...</p>
<div class="codehilite"><pre><span></span>#make it work under singularity
RUN ldconfig 
</pre></div>


<h3 id="iu-hpc-paths">IU HPC paths<a class="headerlink" href="#iu-hpc-paths" title="Permanent link">&para;</a></h3>
<p>Some OS (like RHEL6) don't allow singularity to mount a host path unless there is a corresponding directory already present inside the container (due to lack of overlayfs support by the kernel).</p>
<p>To make your App run on RHEL6 hosts (like IU Karst), please add following somewhere inside your Dockerfile</p>
<div class="codehilite"><pre><span></span>RUN mkdir -p /N/u /N/home /N/dc2 /N/soft
</pre></div>


<h3 id="use-bash">Use Bash<a class="headerlink" href="#use-bash" title="Permanent link">&para;</a></h3>
<p>If you are using ubuntu, by default it changes the default /bin/sh to point to a thing called "dash" rather than "bash". "dash" is simpler/faster to load than "bash", but unfortunately it breaks a lot of programs that expects /bin/sh to point to bash. To correct this, you can add following in your Dockerfile to reset it to bash.</p>
<div class="codehilite"><pre><span></span>#https://wiki.ubuntu.com/DashAsBinSh
RUN rm /bin/sh &amp;&amp; ln -s /bin/bash /bin/sh
</pre></div>


<p>Now, your container should be ready to GO!</p>
<h2 id="example-dockerfile-for-environment-containers">Example Dockerfile for environment containers<a class="headerlink" href="#example-dockerfile-for-environment-containers" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/brain-life/app-dipy-workflows/blob/master/Dockerfile">brain-life/app-dipy-workflows</a></li>
<li><a href="https://github.com/brain-life/docker-mcr">brain-life/docker-mcr</a></li>
</ul>
<h2 id="examples-apps-using-environment-containers">Examples Apps using environment containers<a class="headerlink" href="#examples-apps-using-environment-containers" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/brain-life/app-freesurfer">github brain-life/app-freesurfer</a></li>
<li><a href="https://github.com/brain-life/app-wmaSeg">github brain-life/app-wmaSeg</a></li>
</ul>
<!--

Matlab App Exmple 

* [github brain-life/app-life](https://github.com/brain-life/app-life)
* [dockerhub brainlife/life](https://hub.docker.com/r/brainlife/life/) (Dockerhub Autobuild)

Dipy (python) App Example

* [github brain-life/app-dipy-workflows](https://github.com/brain-life/app-dipy-workflows)

-->
                
                  
                
              
              
                
                  


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://brain-life.github.io/docs/apps/container/";
      this.page.identifier =
        "apps/container/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//brain-life.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../register/" title="Registering App" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Registering App
              </span>
            </div>
          </a>
        
        
          <a href="../versioning/" title="Versioning Tips" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Versioning Tips
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 - 2018 Brainlife.io
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/brain-life" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/BrainLifeio" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.8eb9be28.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>