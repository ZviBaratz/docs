# Pipelines

Processes tab allows you to submit tasks one at a time. This is great if you are exploring different Apps, or trying different mix of Apps or a set of configurations that can best process your datasets. However, once you find the best Apps you probably want to run them across many subjects, and submitting them one by one is simply not an option. This is often called batch processing.

When you are processing a large number of subjects, you would inevitably come across a few failed subjects that requires a custom processing that's different from all the other subjects. This might be due to data quality issue, incorrect metadata, etc. With a common workflow orchestration systems, you will be tasked to develop a workflow script or some sort, submit it, and keep up with witch subjects has failed on which part of the workflow so that you can repeatedly re-submit a partial workflow until all subjects are processed.

## Pipeline Rules

On Brainlife, we've implemented a system where you can setup a series of submission rules called *pipeline rules*. Instead of describing the entire workflow that you *submit* once (or re-submit in case of failure), you will define a set of individual rules which will be continuously evaluated until you stop them. You can think of this as a factory assembly line. When a subject fails to produce an output from one rule, you can examine them individually and reprocess it manually. Once you are able to produce a valid output, the rest of the pipeline rules will pick it up as if it came from the original rule. We believe our rule based submission system is easier to setup, and more error tolerant that more conventional orchestration methods (it is also much easier to implement).

To setup a new rule, go to Project > Pipeline tab, and click a plus button at the bottom right corner of the page.

Each rule will be responsible for submitting a specific App with specific set of configuration on all matching subjects. Enter `Name` field, and search for the App that you'd like to submit. Once you select an App, you will be able to set its configuration parameters.

![pipeline.app](/img/pipeline.app.png)

All Brainlife App has a defined list of input datatypes that the App needs to run. Using this information, Brainlife will look for any subjects inside your projects that provides all input datatypes used by the App, and submit new process to run your App for each subject found. If you have more than one datasets that matches the required datatype for a subject, you can specify which datasets to use by specifying a dataset tags (not datatype tags). By default, it will use the latest datasets available.

For your first rule, you probably don't have any datasets archived inside your project. If you'd like to use datasets from other projects as an initial input datasets, you can specify the `Project` field and point to where you want to look for the input datasets.

The following is an example input configuration for our first App.

![pipeline.input](/img/pipeline.input.png)

This rule will submit processes for each subject found on ABIDE2 projects that provides `dwi` datatype with dataset tags of "ABIDEII-BNI_1".

Brainlife will only submit new process if it hasn't submitted a new process for each rule for each subject. However, you also don't want to submit it if your project already has a desired output datasets (maybe generated by other rules, or generated manually). For this, you will also need to setup an output configuration.

![pipeline.output](/img/pipeline.output.png)

You can leave the output tags empty if you are sure that you will not be submitting any other rules that generates datasets with the same output datatype. We recommend always set output dataset tags just in case.

Lastly, you can set a `Subject Filtering` which limits the subjects that gets processed.

![pipeline.filter](/img/pipeline.filter.png)

Above example will make this rule to only submit for subjects that starts with 100 and 200. When you are setting up your first rule, it's always good to limit subject and make sure your rule is setup correctly.

!!! hint
    There are number of regular expression tutorials available online. Also, please feel free to send us your question via Brainlife slack team.

## Monitoring Pipeline Rules

Once you submit your pipeline, it might take 10 - 20 minutes before you start seeing new processes submitted by Brainlife's pipeline handler.

![pipeline.processes](/img/pipeline.processes.png)

You can treat these processes as you would normally do with any other processes; examine outputs, stop, restart, etc.. The output datasets will be automatically archived once each task have completed successfully. 

!!! note
    If you remove a process or task, however, Brainlife will resubmit another process to handle that subject if the subject can be processed (has all input datasets) and has not produce the output from the requested app yet. 



